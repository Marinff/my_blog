---
title: 注册表
date: '2025-05-05 09:34:43'
updated: '2025-05-08 23:53:29'
permalink: /post/registration-form-1lka0.html
comments: true
toc: true
---



# 注册表

## 注册表

注册表是windows操作系统的核心，是一个系统预定义的庞大的数据库，存放了有关计算机硬件的配置信息、系统和应用的初始化信息等等

应用程序使用注册表API检索、修改或删除注册表数据

### 主要作用

* 记录安装信息
* 设置硬件
* 设置软件
* 定制windows
* 系统安全管理
* 自动运行程序
* 网络设置

### 存储方式

注册表的存储位置和Windows的版本变化有关，Windows NT和Windows 95的存储方式有很大区别
在早期的Windows 3.x系列中，注册表只有一个reg.dat文件，现在变为HKEY_CLASSES_ROOT分支

在windows xp以前，注册表文件存在于

```
C:\WINNT\SYSTEM32\CONFIG
```

xp之后就存在于

```
C:\WINDOWS\SYSTEM32\CONFIG
```

### 数据结构

注册表以树作为结构，由键、值构成

**键**是树状数据结构中的一个节点，而**子键**就是这个节点的子节点，子键也是键，子键是相对的。
**值**是一个键的一条属性，一个值由**名称**、**数据类型**、**数据**组成，一个键可以由一个或多个值，值可以采用任何形式，每个值的名称不能相同，如果名称是空的，那么这个值为该键的默认值

注册表有这五个主树

|名称|作用|
| -------------------| -------------------------------------------------------|
|HKEY_CLASSES_ROOT|存储windows可识别的文件类型的详细列表，以及相关联的程序|
|HKEY_CURRENT_USER|存储当前用户设置的信息|
|HKEY_LOCAL_MACHINE|包括安装在计算机上的硬件和软件的信息|
|HKEY_USERS|包含使用该计算机用户的信息|
|HKEY_CURRENT_CONFIG|包含计算机当前的硬件配置信息|

![](https://pic.imgdb.cn/item/670f7f1fd29ded1a8c0f279d.png)

每个键都有一个或多个可打印字符组成的名称，键名称不区分大小写，键名称不能包含`\`字符。值名称和数据可以包含`\`

例如7-zip是一个键，Compression、Extraction、FM就是他的子键，1、2、3就是他的值项，还有一个默认值

![](https://pic.imgdb.cn/item/670f8963d29ded1a8c1b06b6.png)

* 注册表树的深度可以为512级，通过单个注册表API调用，一次最多可以创建32个级别

#### 数据类型

|显示类型|数据类型|说明|
| -------------| ------------| ----------------------------------------------------------------|
|REG_SZ|字符串|文本字符串|
|REG_BINARY|二进制数|不定长度的二进制值，以十六进制显示|
|REG_DWORD|双字|一个32位的二进制值，显示为8位的十六进制值|
|REG_MULTI_SZ|多字符串|含有多个文本值的字符串，此名来源于字符串间用nul分隔，结尾两个nul|
|REG_EXPAND_SZ|可拓展字符串|含有环境变量的字符串|

在数据放入注册表之前，应用将数据分为两类：计算机特定数据和用户特定数据
通过这种区分，应用可以支持多个用户同时通过网络查找用户特定数据并在不同位置使用该数据，从而允许使用与位置无关的用户配置文件数据

### 注册表配置单元

配置单元是注册表中的键、子键和值的逻辑组，当操作系统启动或用户登录时，会将一组支持文件加载到内存中

注册表文件有两种格式：标准格式和最新格式。
标准格式是Windows 2000 支持的唯一格式，为了向后兼容，windows 的更高版本也支持该格式
从Windows XP开始支持最新格式，在支持最新格式的Windows中，以下配置单元仍使用标准格式
**HKEY_CURRENT_USER**、**HKEY_LOCAL_MACHINE\SAM**、**HKEY_LOCAL_MACHINE\Security**和**HKEY_USERS**​ **.**​**DEFAULT**

大部分配置单元的支持文件位于  **%SystemRoot%\System32\Config** 目录下，这些文件的文件拓展名指示了他们包含的数据类型

|拓展名|描述|
| ------| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|none|配置单元的副本|
|.alt|重要HKEY_LOCAL_MACHINE\System配置单元的备份副本。只有 System 键才有 .alt 文件|
|.log|键和值在注册表中修改的日志文件|
|.sav|配置单元的副本，适用于Windows server 2003 和 Windows XP/2000 这些是注册表文件在安装程序的文本模式阶段结束时的备份副本<br />安装程序有两个阶段：文本模式和图像模式，当文本模式结束后，注册表被复制到一个 .sav文件中<br />如果安装程序在图像模式失败，计算机重启只会重新运行图形化模式阶段，而.sav文件用于恢复注册表数据|

|配置单元|支持的文件|
| --------| ------------------------------------------|
|**HKEY_CURRENT_CONFIG**|System, System.alt, System.log, System.sav|
|**HKEY_CURRENT_USER**|Ntuser.dat, Ntuser.dat.log|
|**HKEY_LOCAL_MACHINE\SAM**|Sam, Sam.log, Sam.sav|
|**HKEY_LOCAL_MACHINE\Security**|Security, Security.log, Security.sav|
|**HKEY_LOCAL_MACHINE\Software**|Software, Software.log, Software.sav|
|**HKEY_LOCAL_MACHINE\System**|System, System.alt, System.log, System.sav|
|**HKEY_USERS**​ **.**​**DEFAULT**|Default, Default.log, Default.sav|

### 预定义键

> 在windows中，进程的代码和数据不会全部装到内存中，进程的某一段装入内存后，可能被换出道外存，之后有需要再装入内存，两次的地址绝大部分情况下是不一样的
> 也就是说，同一对象在内存中的地址会变化，windows为了解决这个问题，引入了**句柄**
>
> **句柄**：系统为每个进程在内存中分配一定的区域，用来存放各个句柄，即**32位无符号整型值**，每个32位无符号整型值相当于**指针**，指向内存的另一个区域A，这个区域A存放的是对象在内存中的地址，当对象在内存中的位置发生变化时，区域A的值会被更新
> 在这个过程中，区域A本身的地址和对应句柄的值是不变的
>
> * 有一个固定的地址(句柄)，指向固定的地址(区域A)，而区域A的值动态变化，指向对应对象在内存中的值
>
> 所以，当我们掌握了句柄的值，就可以定位到对象
>
> * **细节**：句柄的不变是指在程序的一次运行中，如果关闭程序，再次启动，那么句柄一般会变化
>   句柄只能被读取，不能被修改

应用程序必须先打开键，才能把数据添加到注册表，要打开密钥，应用剔骨一个已经打开的注册表中的另一个键的句柄，系统定义了一些始终保持打开状态的预定义键
预定义键帮助应用在注册表中导航，使系统管理员能够使用开发工具来操作特定的数据类别

#### HKEY_CLASSES_ROOT

这个键包含了文件拓展名关联和COM类注册信息

类注册和文件拓展名信息存储在**HKEY_LOCAL_MACHINE**和**HKEY_CURRENT_USER**下

* HKEY_LOCAL_MACHINE  **\Software\Classes**键包含了本地计算机所有用户的默认设置
* HKEY_CURRENT_USER  **\Software\Classes**键包含仅适用于交互式用户的设置

> 要更改默认设置，要直接在**MACHINE\Software\Classes**中修改
>
> 如果将**键**写入**ROOT**下的键，系统会将信息存储在**MACHINE\Software\Classes**下
>
> 如果将**值**写入**ROOT**下的键，并且该键存在于**USER\Software\Classes**下，系统就会把信息存在USER中

### 打开、创建和关闭键

应用要创建或打开一个键，然后才能将数据添加到注册表，应用始终将该键作为当前打开的键的子键应用。

以下预定义键始终处于打开状态：**HKEY_LOCAL_MACHINE**、**HKEY_CLASSES_ROOT**、**HKEY_USERS**和**HKEY_CURRENT_USER**

### 写入和删除注册表数据

应用程序可以用**RegSetValueEx**函数将值及其数据和键关联

要从键中删除值，应用要使用**RegDeleteValue**函数
